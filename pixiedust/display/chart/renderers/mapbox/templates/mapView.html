<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pixiedust Mapbox map</title>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.css" rel="stylesheet" />
    <style>
    .mapboxgl-popup-content h3 { 
        margin: 2px 0 2px 0;
        font-style: italic;
    }
    .mapboxgl-popup {
        max-width: 200px;
    }
    #map canvas {
        cursor: crosshair;
    }
    .legend {
        background-color: rgba(255,255,255, 0.75);
        border-radius: 3px;
        position: absolute;
        right: 30px;
        bottom: 14px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.10);
        font-size: 12px;
        line-height: 18px;
        padding: 10px;
        z-index: 1;
    }
    .legend h4 {
        margin: 0 0 10px;
    }
    .legend div span {
        border-radius: 50%;
        display: inline-block;
        height: 10px;
        margin-right: 5px;
        width: 10px;
    }
    body { 
        background-color:#333; 
        margin:0px !important; 
        overflow: hidden;
        font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    </style>
</head>
<body>
<div id="map{{prefix}}" style="width:calc({{prefwidth}}px - 4px);height:calc({{prefheight}}px - 4px)" />

{%if this.options.get("legend") == "true" %}
<div id="maplegend" class="legend">
    {% if this.options.get("kind") and this.options.get("kind") != "simple-cluster" %}
        <h4>{{this.options.get("groupBy")}}</h4>
        {% for bin in bins %}
        <div><span style="background-color: {{bin[1]}}"></span>{{bin[0]}}</div>
        {% endfor %}
    {%endif%}
</div>
{%endif%}

<script>
    var comment = "";
    mapboxgl.accessToken="{{this.options.get('mapboxtoken')}}";
    var map = new mapboxgl.Map({
        container: "map{{prefix}}",
        style: "mapbox://styles/mapbox/{{this.options.get('basemap', 'light-v9')}}"
    });

    var popup = new mapboxgl.Popup({closeButton: false,closeOnClick: true});
    
    map.on("mousemove", function (e) {
        var fs = map.queryRenderedFeatures(e.point,{layers:["pxlayer"{%for l in userlayers%},"{{l['id']}}"{%endfor%}]});
        if (!fs || !fs.length) {popup.remove();return;};
        popuphtml = "";
        var hr = false;
        fs.forEach(function(f){
            if (hr){ 
                popuphtml += "<hr>\n";
            }
            hr=true;
            popuphtml += "<h3>"+f.layer.id.toUpperCase()+"</h3>\n";
            var keylength = Object.keys(f.properties).length;
            for (var key in f.properties) {
                popuphtml += "<b>"+key+": </b> "+f.properties[key]+"<br/>\n";
            }
        });
        popup.setLngLat(e.lngLat).setHTML(popuphtml).addTo(map);
    });
    
    map.on("click", function (e) {
        var fs = map.queryRenderedFeatures(e.point, { layers: ["pxlayer"] });
        if (fs.length) {
            var f = fs[0];
            console.log("clicked", f);
            var keylength = Object.keys(f.properties).length;
            var payload = {type:"select", targetDivId: "{{this.options.get("targetDivId","") }}" };

            for (var key in f.properties) {
                payload[key] = f.properties[key];
            }

            if (window.triggerPDEvent) {
                window.triggerPDEvent(payload);
            }
        }
    });
        
    map.on("load", function() {
        var mapdata={{this.options.get("mapData")}};
        {%if this.options.get("kind") != "densitymap" %}
            var clusterme = false;
            {% if this.options.get("kind") and this.options.get("kind").find("cluster") >= 0 %}
                clusterme = true;
            {% endif %}
            map.addSource("pxdatasource", {
                "type":"geojson",
                "data":mapdata,
                "cluster": clusterme, 
                "clusterMaxZoom": 14, 
                "clusterRadius": 20
            });
            map.addLayer({
                "id":"pxlayer",
                "type":"circle", 
                "source": "pxdatasource", 
                "paint": {{this.options.get("mapStyle")}}
            });
            if (clusterme) {
                map.addLayer({
                    "id": "cluster-count-labels", 
                    "type": "symbol", 
                    "source": "pxdatasource", 
                    "paint": {
                        "text-color": "#FFF"
                    },
                    "layout": {
                        "text-field": "{point_count}", 
                        "text-font": [
                            "DIN Offc Pro Medium", 
                            "Arial Unicode MS Bold"
                        ],
                        "text-size": 12
                    }
                });
            }

            map.addLayer({
              "id" : "newpoints",
              "type" : "symbol",
              "source" : {
                "type" : "geojson",
                "data" : {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.43315,5.030526]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":1,"coffee_plant_name":"DECAFFEINATION FACTORY","latitude":5.030526,"longitude":-75.43315,"type":"Coffee Production","size":"","city":"Manizales"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.492012,5.135184]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":2,"coffee_plant_name":"Cafe Tio Conejo","latitude":5.135184,"longitude":-75.492012,"type":"Coffee Farm","size":"","city":"Manizales"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-74.072092,4.710989]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":16,"coffee_plant_name":"BANCA EXPORTADORA S.A.","latitude":4.710989,"longitude":-74.072092,"type":"Coffee Roaster","size":"","city":"Bogota"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.56366,5.038081]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":3,"coffee_plant_name":"Hacienda Venecia","latitude":5.038081,"longitude":-75.56366,"type":"Coffee Farm","size":"","city":"Manizales"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.60664,4.95691]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":4,"coffee_plant_name":"Hacienda Guayabal","latitude":4.95691,"longitude":-75.60664,"type":"Coffee Farm","size":"","city":"Manizales"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.761865,4.625907]},"properties":{"cartodb_id":17,"coffee_plant_name":"Cafe Aborigen SAS","latitude":4.625907,"longitude":-75.761865,"type":"Coffee Distributor","size":"","city":"Quimbaya"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.70384,4.837534]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":5,"coffee_plant_name":"Don Manolo Cafe","latitude":4.837534,"longitude":-75.70384,"type":"Coffee Farm","size":"","city":"Pereira"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.595299,4.623735]},"properties":{"cartodb_id":6,"coffee_plant_name":"Ocaso Cafe Tour","latitude":4.623735,"longitude":-75.595299,"type":"Coffee Farm","size":"","city":"Salento"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.636307,6.09595]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":18,"coffee_plant_name":"Cafe Almendra Selecta SAS","latitude":6.09595,"longitude":-75.636307,"type":"Coffee Roaster","size":"","city":"Antioquia"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.578984,4.640954]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":7,"coffee_plant_name":"Finca Don Eduardo Coffee Farm","latitude":4.640954,"longitude":-75.578984,"type":"Coffee Farm","size":"","city":"Salento"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.595299,4.623735]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":8,"coffee_plant_name":"Tour de la Finca Cafetera Las Brisas, Don Elias","latitude":4.623735,"longitude":-75.595299,"type":"Coffee Farm","size":"","city":"Salento"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-74.094986,11.122935]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":11,"coffee_plant_name":"El Bistro de La Victoria","latitude":11.122935,"longitude":-74.094986,"type":"Coffee Production","size":"","city":"Minca"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.589196,4.62332]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":9,"coffee_plant_name":"Las Acacias Coffee Farm","latitude":4.62332,"longitude":-75.589196,"type":"Coffee Farm","size":"","city":"Salento"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.760834,4.622627]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":10,"coffee_plant_name":"Cafe de Altura","latitude":4.622627,"longitude":-75.760834,"type":"Coffee Farm","size":"","city":"San Ramon"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-76.048869,1.853]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":12,"coffee_plant_name":"Amigos Amg Ltda","latitude":1.853,"longitude":-76.048869,"type":"Coffee Roaster","size":"","city":"Pitalito"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.6253,5.6152]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":13,"coffee_plant_name":"Ana Isabel Gaviria Arteaga","latitude":5.6152,"longitude":-75.6253,"type":"Coffee Roaster","size":"","city":"Valparaíso, Antioquia"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-76.513062,3.492812]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":14,"coffee_plant_name":"Arbelaez Valencia HnosTostadora de Cafe Mejia SA","latitude":3.492812,"longitude":-76.513062,"type":"Coffee Roaster","size":"","city":"Cali"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.496809,5.07323]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"circle","cartodb_id":15,"coffee_plant_name":"Asociación Mujer y Café","latitude":5.07323,"longitude":-75.496809,"type":"Coffee Distributor","size":"","city":"Manizales"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-75.8,4.85]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"triangle","cartodb_id":1,"name":"Cordillera Chocolate Growers","lat":4.85,"long":-75.8,"type":"Cacao Farm"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-76.614739,2.444814]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"triangle","cartodb_id":2,"name":"Cacao Hunters","lat":2.444814,"long":-76.614739,"type":"Cacao Producer"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-74.119829,4.638708]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"triangle","cartodb_id":3,"name":"Luker","lat":4.638708,"long":-74.119829,"type":"Cacao Producer"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-74.072092,4.710989]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"triangle","cartodb_id":4,"name":"Manifesto Cacao","lat":4.710989,"long":-74.072092,"type":"Cacao Farm + Producer"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[-73.653621,6.643708]},"properties":{"marker-color":"#7e7e7e","marker-size":"medium","icon":"triangle","cartodb_id":5,"name":"Santander","lat":6.643708,"long":-73.653621,"type":"Cacao Producer"}}
                ]}
              },
              "layout": {
                    "icon-image": "{icon}-11",
                    "icon-size" : 2
                }
            });
        
            map.addLayer({
              "id" : "ardillapoints",
              "type" : "symbol",
              "source" : {
                "type" : "geojson",
                "data" : {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Incauca S.A.S.","icon":"star"},"geometry":{"type":"Point","coordinates":[-76.3228751,3.2778029]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Sucroal","icon":"star"},"geometry":{"type":"Point","coordinates":[-76.343896,3.514805]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Nucleos de Madera","icon":"star"},"geometry":{"type":"Point","coordinates":[-75.58495044708252,6.20246405987307]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Postobon, S.A.","icon":"star"},"geometry":{"type":"Point","coordinates":[-75.5590295791626,6.328649355273761]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"RCN Radio Cadena Nacional","icon":"star"},"geometry":{"type":"Point","coordinates":[-74.06872987747192,4.62514800735916]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"RCN Television","icon":"star"},"geometry":{"type":"Point","coordinates":[-74.1199278831482,4.629553879825614]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Ingenio Risaralda","icon":"star"},"geometry":{"type":"Point","coordinates":[-75.89355468749999,4.904459212814563]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Edinsa","icon":"star"},"geometry":{"type":"Point","coordinates":[-75.57782649993896,6.226056796004427]}},{"type":"Feature","properties":{"marker-color":"#7e7e7e","marker-size":"medium","marker-symbol":"","Name":"Crown Colombia","icon":"star"},"geometry":{"type":"Point","coordinates":[-73.96060466766356,4.965301370533173]}}]}

                },
                "layout": {
                    "icon-image": "{icon}-11",
                    "icon-size" : 2
                }

            });
        {% else %}
        map.addSource("pxdatasource", {
            "type":"geojson",
            "data":mapdata,
            "cluster": true, 
            "clusterMaxZoom": 11, 
            "clusterRadius": 20
        });
        var layers = [];
        {% for bin in bins %}
            layers.push([{{bin[0]}}, "{{bin[1]}}"]);
        {% endfor %}

        layers.forEach(function(layer,i) {
            map.addLayer({
                "id": "cluster-" + i, 
                "type": "circle", 
                "source": "pxdatasource", 
                "paint": {
                    "circle-color": layer[1],
                    "circle-radius": 70, 
                    "circle-blur": 1
                }, 
                "filter": i === layers.length-1 ? [">=", "{{this.options.get("mapValueField")}}", layer[0]] : 
                    ["all", [">=", "{{this.options.get("mapValueField")}}", layer[0]], ["<", "{{this.options.get("mapValueField")}}", layers[i+1][0]]]

            }, "waterway-label");
        });
        
        map.addLayer({
            "id": "pxlayer", 
            "type": "circle", 
            "source": "pxdatasource", 
            "paint": {
                "circle-color": "rgba(0,255,0,0.5)", 
                "circle-radius": 20, 
                "circle-blur": 1
            }, 
            "filter": ["!=", "cluster", true]
        }, "waterway-label");

        {% endif %}

        comment = "Add user layers";
        var layers = [];
        {% for layer in userlayers %}
            var layertype = "circle";
            {% if layer["type"] %}
            layertype = {{layer["type"]|jsonify}};
            {%endif%}
            
            var layerpaint = {};
            {% if layer["paint"] %}
            layerpaint = {{layer["paint"]|jsonify}};
            {%endif%}

            var layerlayout = {};
            {% if layer["layout"] %}
            layerlayout = {{layer["layout"]|jsonify}};
            {%endif%}

            var newlayer = {
                "id": {{layer["id"]|jsonify}},
                "type": layertype, 
                "source": {{layer["source"]|jsonify}},
                "paint": layerpaint, 
                "layout": layerlayout
            };
            layers.push([newlayer, {{layer["order"]|jsonify}}]);
        {% endfor %}
        layers.sort(function(a,b) {
            return a[1] - b[1];
        });
        for (layersi=layers.length-1; layersi>=0; layersi--) {
            map.addLayer(layers[layersi][0]);
            comment = "User layer legend";
            {%if this.options.get("legend") == "true" %}
                var t = document.createElement("h4");
                t.appendChild(document.createTextNode(layers[layersi][0].id));
                document.getElementById("maplegend").appendChild(t);
            {% endif %}
        }

        map.fitBounds({{this.options.get("mapBounds")}});
        
    });
</script>
</body>
</html>
